<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Simulating: {{ era.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=9">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- MISSION BRIEFING MODAL -->
        <div id="mission-briefing"
            style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:20000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
            <div
                style="background:#111; border:1px solid #333; padding:40px; max-width:600px; border-radius:16px; text-align:center; box-shadow:0 0 50px rgba(0,0,0,0.8);">
                <h1 style="font-size:2rem; margin-bottom:10px; color:#fff;">MISSION: {{ era.name }}</h1>
                <p style="color:#aaa; font-size:1.1rem; line-height:1.6; margin-bottom:30px;">
                    {{ era.description }}<br><br>
                    You have <span style="color:#00ff9d">$10,000</span>. The market is about to move.<br>
                    Slide RIGHT (Positive) to <b>BUY/LONG</b>.<br>
                    Slide LEFT (Negative) to <b>SELL/SHORT</b>.<br>
                    Invest wisely before the crash.
                </p>
                <button class="btn-primary" onclick="document.getElementById('mission-briefing').style.display='none'"
                    style="width:200px; margin:0 auto; display:block;">ENTER SIMULATION</button>
            </div>
        </div>

        <!-- Sidebar: Controls -->
        <div class="sidebar">
            <div style="border-bottom: 1px solid #333; padding-bottom: 20px;">
                <a href="/" class="mono" style="font-size: 0.8rem; color: #666;">
                    < BACK_TO_TIMELINE</a>
                        <h2 style="margin-top: 10px;">{{ era.name }}</h2>
            </div>

            <div class="card card-assets">
                <h3 style="font-size: 0.9rem; margin-bottom: 15px;">ASSET_ALLOCATION</h3>
                <!-- Search -->
                <input type="text" id="ticker-search" placeholder="SEARCH_TICKER..."
                    style="width:100%; padding:8px; margin-bottom:15px; background:#000; border:1px solid #333; color:#fff; font-family:monospace;"
                    onkeyup="filterTickers()">

                <div id="asset-inputs">
                    {% for asset in era.assets %}
                    <div class="asset-row" style="flex-wrap:wrap; gap:10px;">
                        <div
                            style="display:flex; align-items:center; gap:5px; width:100%; justify-content:space-between;">
                            <div style="display:flex; align-items:center;">
                                <span class="mono" style="font-weight:bold; color:#fff;">{{ asset.ticker }}</span>
                                <div class="tooltip-trigger" data-tooltip="{{ asset.description }}">
                                    <span class="info-icon">?</span>
                                </div>
                            </div>
                            <span class="mono val" style="text-align: right; font-weight:bold;">0%</span>
                        </div>

                        <!-- Slider Container -->
                        <div style="display:flex; align-items:center; width:100%; gap:8px;">
                            <span style="font-size:0.6rem; color:#ff3b30; text-transform:uppercase;">Short</span>
                            <input type="range" class="allocation-slider" data-ticker="{{ asset.ticker }}" min="-100"
                                max="100" value="0" step="10" oninput="updateAllocation()" style="flex:1;">
                            <span style="font-size:0.6rem; color:#30d158; text-transform:uppercase;">Long</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mono" style="margin-top: 10px; text-align: right; color: #666;">
                    TOTAL: <span id="total-alloc">0</span>%
                </div>
            </div>

            <div class="card" style="margin-top: auto;">
                <h3 style="font-size: 0.8rem; color: #888;">PORTFOLIO_VALUE</h3>
                <div class="portfolio-value green" id="current-value">$10,000</div>
            </div>

            <div class="btn" onclick="startSimulation()">RUN_SIMULATION__</div>
        </div>

        <!-- Main Panel: Chart -->
        <div class="main-panel">
            <div class="chart-wrapper">
                <canvas id="marketChart"></canvas>
            </div>

            <!-- Immersive News Banner (Integrated) -->
            <div id="news-banner" class="news-banner">
                <div class="news-icon">‚óè</div>
                <div class="news-content">
                    <div id="news-title" class="news-headline">MARKET CRASH</div>
                    <div id="news-desc" class="news-subtext">Details here...</div>
                </div>
            </div>

            <div class="card" id="event-log" style="overflow-y: scroll;">
                <div style="color: #666;">> SYSTEM READY... WAITING_FOR_INPUT</div>
            </div>
        </div>
    </div> <!-- Close app-container -->

    <!-- Clean background -->

    <!-- GLOBAL TOOLTIP -->
    <div id="global-tooltip"></div>

    <!-- Tooltip Logic -->
    <script>
        const tooltip = document.getElementById('global-tooltip');
        let activeTrigger = null;

        const showTooltip = (trigger) => {
            const text = trigger.getAttribute('data-tooltip');
            // Look for the sibling .mono span which contains the ticker
            const tickerEl = trigger.parentElement.querySelector('.mono');
            const ticker = tickerEl ? tickerEl.innerText : 'ASSET';

            // Clean Header Style
            tooltip.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; padding-bottom:6px; border-bottom:1px solid #444;">
                    <strong style="color:#2997ff; font-size:0.9rem;">${ticker}</strong>
                </div>
                <span style="color:#ccc;">${text}</span>
            `;
            tooltip.classList.add('visible');
            activeTrigger = trigger;

            // Position
            updatePosition(trigger);
        };

        const hideTooltip = () => {
            tooltip.classList.remove('visible');
            activeTrigger = null;
        };

        const updatePosition = (trigger) => {
            if (!trigger) return;
            const rect = trigger.getBoundingClientRect();

            // Reset classes
            tooltip.classList.remove('left-side', 'right-side');

            // Check if close to right edge
            if (rect.left > window.innerWidth - 320) {
                tooltip.style.left = (rect.left - 290) + 'px'; // Show on left
                tooltip.classList.add('left-side');
            } else {
                tooltip.style.left = (rect.left + 35) + 'px'; // Show on right
                tooltip.classList.add('right-side');
            }
            // Align vertically with the trigger
            tooltip.style.top = (rect.top - 15) + 'px';
        };

        document.querySelectorAll('.tooltip-trigger').forEach(trigger => {
            // Desktop Hover
            trigger.addEventListener('mouseenter', () => showTooltip(trigger));
            trigger.addEventListener('mouseleave', () => hideTooltip());

            // Mobile/Click (Toggle)
            trigger.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent doc click
                if (activeTrigger === trigger && tooltip.classList.contains('visible')) {
                    hideTooltip();
                } else {
                    showTooltip(trigger);
                }
            });
        });

        // Close on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.tooltip-trigger') && !e.target.closest('#global-tooltip')) {
                hideTooltip();
            }
        });

        // Update position on scroll/resize
        window.addEventListener('scroll', () => hideTooltip(), true);
        window.addEventListener('resize', () => hideTooltip());
    </script>

    <!-- Pass Era ID to JS -->
    <script>const ERA_ID = "{{ era.id }}";</script>
    <script src="{{ url_for('static', filename='js/chart_logic.js') }}"></script>
</body>

</html>